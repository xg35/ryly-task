name: Supabase DB Migration

on:
  push:
    branches:
      - main

jobs:
  migrate-db:
    name: Migrate Supabase DB
    runs-on: ubuntu-latest

    env:
      # Needed for 'supabase link' and potentially other commands
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      # Needed for 'supabase db push' to connect to the database
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      # Needed for 'supabase link' to identify the project
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Or '18', 'lts/*'

      - name: Link Supabase project
        # Use npx to execute the link command
        # Reads SUPABASE_ACCESS_TOKEN and SUPABASE_PROJECT_ID from env
        # Also needs the DB password for validation during link
        run: npx supabase@latest link --project-ref $SUPABASE_PROJECT_ID
        # Note: The link command implicitly uses the SUPABASE_DB_PASSWORD env var as well now.
        # If you encounter password prompts, you might need to explicitly pass it:
        # run: echo "$SUPABASE_DB_PASSWORD" | npx supabase@latest link --project-ref $SUPABASE_PROJECT_ID

      - name: Run Supabase DB Migrations
        # Now that the project is linked, db push should know where to go
        # It uses SUPABASE_DB_PASSWORD from env for the connection
        run: npx supabase@latest db push
